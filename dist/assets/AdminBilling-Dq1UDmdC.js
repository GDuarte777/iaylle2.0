import{c as be,j as r,x as ve,I as p,H as i,o as e,aa as F,N as x,ac as Ne,a2 as Ce}from"./index-D9dO6jDR.js";import{G as we}from"./GlassCard-3LL1uNH4.js";import{T as ye,a as _e,b as D,c as E}from"./tabs-BzIc16-c.js";import{I as g}from"./input-B-CVJ1EK.js";import{D as K,a as Q,E as W,b as Y,c as ee,d as T,e as b}from"./dropdown-menu-_ymKA9PI.js";import{D as se,a as ae,c as re,b as ne}from"./dialog-CTG_fKa3.js";import{T as P,a as R,b as h,c as t,d as A,e as o}from"./table-Dt-GE31l.js";import{S as ke}from"./search-D1XwfXfN.js";import"./index-DwWHu9OX.js";import"./index-CfA0gxda.js";import"./index-CQKvY29V.js";import"./check-DPcULkwW.js";import"./index-CREuF23G.js";const Se=[["path",{d:"M2 9a3 3 0 1 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 1 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z",key:"1l48ns"}],["path",{d:"M9 9h.01",key:"1q5me6"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"M15 15h.01",key:"lqbp3k"}]],Le=be("ticket-percent",Se),De=l=>(l/100).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});function qe(){const[l,te]=r.useState("subscriptions"),[f,oe]=r.useState(""),[ie,M]=r.useState(!0),[C,$]=r.useState([]),[ce,B]=r.useState(!0),[w,U]=r.useState([]),[le,O]=r.useState(!0),[I,z]=r.useState([]),{plans:de,fetchPlans:H}=ve(),[j,y]=r.useState(null),[ue,v]=r.useState(!1),[_,q]=r.useState(""),[k,V]=r.useState(""),[S,G]=r.useState(10),[N,J]=r.useState("");r.useEffect(()=>{H()},[H]);const me=r.useCallback(s=>`https://dashboard.stripe.com/customers/${s}`,[]),pe=r.useCallback(s=>`https://dashboard.stripe.com/subscriptions/${s}`,[]),d=r.useCallback(async()=>{M(!0);try{const{data:s,error:a}=await p.from("subscriptions").select("id, user_id, status, started_at, current_period_end, canceled_at, external_customer_id, external_subscription_id, plan:plans(id, name, price_cents, interval), profile:profiles(id, email, full_name, role, status, plan_status)").order("updated_at",{ascending:!1}).range(0,99);if(a)throw a;$(s??[])}catch(s){const a=s instanceof Error?s.message:String(s);i.error(`Erro ao carregar assinaturas: ${a}`),$([])}finally{M(!1)}},[]),L=r.useCallback(async()=>{B(!0);try{const{data:s,error:a}=await p.from("payments").select("id, amount_cents, currency, status, paid_at, created_at, external_invoice_id, subscription:subscriptions(id, user_id, external_subscription_id, plan:plans(name), profile:profiles(email, full_name))").order("created_at",{ascending:!1}).range(0,99);if(a)throw a;U(s??[])}catch(s){const a=s instanceof Error?s.message:String(s);i.error(`Erro ao carregar pagamentos: ${a}`),U([])}finally{B(!1)}},[]),u=r.useCallback(async()=>{O(!0);try{const{data:s,error:a}=await p.functions.invoke("admin-stripe-coupon",{body:{action:"list"}});if(a)throw a;z((s??{}).items??[])}catch(s){const a=s instanceof Error?s.message:String(s);i.error(`Erro ao carregar cupons: ${a}`),z([])}finally{O(!1)}},[]);r.useEffect(()=>{if(l==="subscriptions"){d();return}if(l==="payments"){L();return}u()},[l,u,L,d]);const X=r.useMemo(()=>{const s=f.trim().toLowerCase();return s?C.filter(a=>{const n=a.profile?.email?.toLowerCase()??"",c=a.profile?.full_name?.toLowerCase()??"",m=a.plan?.name?.toLowerCase()??"";return n.includes(s)||c.includes(s)||m.includes(s)}):C},[f,C]),Z=r.useMemo(()=>{const s=f.trim().toLowerCase();return s?w.filter(a=>{const n=a.subscription?.profile?.email?.toLowerCase()??"",c=a.subscription?.profile?.full_name?.toLowerCase()??"",m=a.subscription?.plan?.name?.toLowerCase()??"",ge=a.status?.toLowerCase()??"";return n.includes(s)||c.includes(s)||m.includes(s)||ge.includes(s)}):w},[w,f]),xe=r.useCallback(async(s,a)=>{try{const{data:n,error:c}=await p.functions.invoke("admin-stripe-subscription",{body:{action:"change_plan",userId:s,planId:a,returnUrl:`${window.location.origin}/admin/billing`}});if(c)throw c;if(n&&typeof n=="object"&&n.code==="missing_payment_method"){const m=n.portalUrl;i.error("O usuário precisa adicionar um método de pagamento.",{description:m?"Abra o portal do Stripe para adicionar um cartão.":void 0,action:m?{label:"Abrir portal",onClick:()=>window.open(m,"_blank","noreferrer")}:void 0});return}i.success("Plano alterado com sucesso"),y(null),await d()}catch(n){const c=n instanceof Error?n.message:String(n);i.error(`Erro ao alterar plano: ${c}`)}},[d]),he=r.useCallback(async s=>{try{const{error:a}=await p.functions.invoke("admin-stripe-subscription",{body:{action:"cancel",userId:s}});if(a)throw a;i.success("Assinatura cancelada"),await d()}catch(a){const n=a instanceof Error?a.message:String(a);i.error(`Erro ao cancelar: ${n}`)}},[d]),fe=r.useCallback(async()=>{const s=_.trim();if(!s){i.error("Informe um código");return}try{const{error:a}=await p.functions.invoke("admin-stripe-coupon",{body:{action:"create",code:s,name:k.trim()||void 0,percentOff:Number(S),maxRedemptions:N===""?void 0:Number(N),duration:"once"}});if(a)throw a;i.success("Cupom criado"),v(!1),q(""),V(""),G(10),J(""),await u()}catch(a){const n=a instanceof Error?a.message:String(a);i.error(`Erro ao criar cupom: ${n}`)}},[u,_,N,k,S]),je=r.useCallback(async(s,a)=>{try{const{error:n}=await p.functions.invoke("admin-stripe-coupon",{body:{action:"set_active",promotionCodeId:s,active:a}});if(n)throw n;await u()}catch(n){const c=n instanceof Error?n.message:String(n);i.error(`Erro ao atualizar cupom: ${c}`)}},[u]);return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold mb-2 flex items-center gap-3",children:[e.jsx(F,{className:"w-8 h-8 text-purple-600 dark:text-purple-400"}),"Assinaturas e Cobrança"]}),e.jsx("p",{className:"text-muted-foreground",children:"Controle assinaturas, pagamentos e cupons."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative flex-1 sm:w-80",children:[e.jsx(ke,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(g,{value:f,onChange:s=>oe(s.target.value),placeholder:"Buscar por email, nome, plano...",className:"pl-10 bg-background/60"})]}),e.jsxs(x,{variant:"glass",onClick:()=>{l==="subscriptions"?d():l==="payments"?L():u()},className:"gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"}),"Atualizar"]})]})]}),e.jsx(we,{className:"p-6",children:e.jsxs(ye,{value:l,onValueChange:s=>te(s),children:[e.jsxs(_e,{className:"w-full justify-start",children:[e.jsxs(D,{value:"subscriptions",className:"gap-2",children:[e.jsx(Ce,{className:"w-4 h-4"}),"Assinaturas"]}),e.jsxs(D,{value:"payments",className:"gap-2",children:[e.jsx(F,{className:"w-4 h-4"}),"Pagamentos"]}),e.jsxs(D,{value:"coupons",className:"gap-2",children:[e.jsx(Le,{className:"w-4 h-4"}),"Cupons"]})]}),e.jsx(E,{value:"subscriptions",className:"mt-6",children:ie?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Carregando..."}):X.length===0?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Nenhuma assinatura encontrada."}):e.jsxs(P,{children:[e.jsx(R,{children:e.jsxs(h,{children:[e.jsx(t,{children:"Usuário"}),e.jsx(t,{children:"Plano"}),e.jsx(t,{children:"Status"}),e.jsx(t,{children:"Próxima cobrança"}),e.jsx(t,{className:"text-right",children:"Ações"})]})}),e.jsx(A,{children:X.map(s=>e.jsxs(h,{children:[e.jsx(o,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.profile?.full_name??"(sem nome)"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.profile?.email??"(sem email)"})]})}),e.jsx(o,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.plan?.name??"—"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.plan?`${De(s.plan.price_cents)}/${s.plan.interval==="monthly"?"mês":"ano"}`:""})]})}),e.jsx(o,{className:"capitalize",children:s.status}),e.jsx(o,{children:s.current_period_end?new Date(s.current_period_end).toLocaleDateString("pt-BR"):"—"}),e.jsx(o,{className:"text-right",children:e.jsxs(K,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(x,{variant:"glass",className:"px-3",children:e.jsx(W,{className:"w-4 h-4"})})}),e.jsxs(Y,{align:"end",className:"bg-background/95 backdrop-blur-xl border-border",children:[e.jsx(ee,{children:"Ações"}),e.jsx(T,{className:"bg-border"}),e.jsx(b,{className:"cursor-pointer",onClick:()=>y(s),children:"Trocar plano"}),e.jsx(b,{className:"cursor-pointer text-destructive focus:text-destructive",onClick:()=>{he(s.user_id)},children:"Cancelar assinatura"}),e.jsx(T,{className:"bg-border"}),e.jsx(b,{className:"cursor-pointer",disabled:!s.external_customer_id,onClick:()=>{s.external_customer_id&&window.open(me(s.external_customer_id),"_blank","noreferrer")},children:"Abrir cliente no Stripe"}),e.jsx(b,{className:"cursor-pointer",disabled:!s.external_subscription_id,onClick:()=>{s.external_subscription_id&&window.open(pe(s.external_subscription_id),"_blank","noreferrer")},children:"Abrir assinatura no Stripe"})]})]})})]},s.id))})]})}),e.jsx(E,{value:"payments",className:"mt-6",children:ce?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Carregando..."}):Z.length===0?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Nenhum pagamento encontrado."}):e.jsxs(P,{children:[e.jsx(R,{children:e.jsxs(h,{children:[e.jsx(t,{children:"Usuário"}),e.jsx(t,{children:"Plano"}),e.jsx(t,{children:"Valor"}),e.jsx(t,{children:"Status"}),e.jsx(t,{children:"Data"})]})}),e.jsx(A,{children:Z.map(s=>e.jsxs(h,{children:[e.jsx(o,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.subscription?.profile?.full_name??"(sem nome)"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.subscription?.profile?.email??"(sem email)"})]})}),e.jsx(o,{children:s.subscription?.plan?.name??"—"}),e.jsx(o,{children:(s.amount_cents/100).toLocaleString("pt-BR",{style:"currency",currency:s.currency||"BRL"})}),e.jsx(o,{className:"capitalize",children:s.status}),e.jsx(o,{children:new Date(s.paid_at??s.created_at).toLocaleDateString("pt-BR")})]},s.id))})]})}),e.jsxs(E,{value:"coupons",className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 mb-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Cupons e promoções no Stripe."}),e.jsx(x,{variant:"neon",onClick:()=>v(!0),children:"Criar cupom"})]}),le?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Carregando..."}):I.length===0?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Nenhum cupom encontrado."}):e.jsxs(P,{children:[e.jsx(R,{children:e.jsxs(h,{children:[e.jsx(t,{children:"Código"}),e.jsx(t,{children:"Desconto"}),e.jsx(t,{children:"Uso"}),e.jsx(t,{children:"Status"}),e.jsx(t,{className:"text-right",children:"Ações"})]})}),e.jsx(A,{children:I.map(s=>e.jsxs(h,{children:[e.jsx(o,{className:"font-medium",children:s.code}),e.jsx(o,{children:s.coupon?.percent_off!=null?`${s.coupon.percent_off}%`:s.coupon?.amount_off!=null?String(s.coupon.amount_off):"—"}),e.jsxs(o,{children:[s.times_redeemed,s.max_redemptions!=null?`/${s.max_redemptions}`:""]}),e.jsx(o,{children:s.active?"Ativo":"Inativo"}),e.jsx(o,{className:"text-right",children:e.jsxs(K,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(x,{variant:"glass",className:"px-3",children:e.jsx(W,{className:"w-4 h-4"})})}),e.jsxs(Y,{align:"end",className:"bg-background/95 backdrop-blur-xl border-border",children:[e.jsx(ee,{children:"Cupom"}),e.jsx(T,{className:"bg-border"}),e.jsx(b,{className:"cursor-pointer",onClick:()=>{je(s.id,!s.active)},children:s.active?"Desativar":"Ativar"})]})]})})]},s.id))})]})]})]})}),e.jsx(se,{open:j!=null,onOpenChange:s=>s?void 0:y(null),children:e.jsxs(ae,{className:"w-[95vw] sm:w-full sm:max-w-[520px] bg-background/95 backdrop-blur-xl border-border max-h-[90vh] overflow-y-auto",children:[e.jsx(re,{children:e.jsx(ne,{children:"Trocar plano"})}),e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:j?.profile?.email??""}),e.jsx("div",{className:"grid gap-3",children:de.map(s=>e.jsx("button",{type:"button",className:`w-full text-left p-4 rounded-xl border transition-all flex items-center justify-between ${j?.plan?.id===s.id?"bg-purple-100 dark:bg-purple-500/10 border-purple-300 dark:border-purple-500/50":"bg-muted/30 border-border hover:bg-muted/50"}`,onClick:()=>{j&&xe(j.user_id,s.id)},children:e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"font-bold",children:s.name}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[s.price.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),"/",s.interval==="monthly"?"mês":"ano"]})]})},s.id))})]})]})}),e.jsx(se,{open:ue,onOpenChange:v,children:e.jsxs(ae,{className:"w-[95vw] sm:w-full sm:max-w-[520px] bg-background/95 backdrop-blur-xl border-border max-h-[90vh] overflow-y-auto",children:[e.jsx(re,{children:e.jsx(ne,{children:"Criar cupom"})}),e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Código"}),e.jsx(g,{value:_,onChange:s=>q(s.target.value),placeholder:"EX: PROMO10"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Nome (opcional)"}),e.jsx(g,{value:k,onChange:s=>V(s.target.value),placeholder:"Ex: Promo Janeiro"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"% de desconto"}),e.jsx(g,{type:"number",min:1,max:100,value:S,onChange:s=>G(Number(s.target.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Máximo de resgates (opcional)"}),e.jsx(g,{type:"number",min:1,value:N,onChange:s=>{const a=s.target.value;J(a===""?"":Number(a))}})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(x,{variant:"glass",onClick:()=>v(!1),children:"Cancelar"}),e.jsx(x,{variant:"neon",onClick:()=>{fe()},children:"Criar"})]})]})]})})]})}export{qe as default};
