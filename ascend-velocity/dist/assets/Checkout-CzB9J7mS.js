import{F as M,E as q,x as V,B as z,J as H,j as n,H as c,o as e,L as J,N as j,I as k}from"./index-DidJ2IC_.js";import{G as C}from"./GlassCard-i8sBZgct.js";import{I as K}from"./input-RWOkaWNK.js";import{L as O}from"./label-i_K-zmDS.js";import{L as Q}from"./Logo-kKC3Ri1E.js";import{L as $}from"./lock-BvCJ2wVE.js";import{E as W}from"./external-link-81adldy9.js";import"./index-DKXZ3643.js";function ne(){const[f]=M(),o=q(),r=f.get("plan"),{plans:I,fetchPlans:w,loading:N}=V(),{isAuthenticated:v,isLoading:y}=z(),{subscription:i,loading:D,refresh:S}=H(),g=f.get("session_id"),F=f.get("success")==="1",[P,B]=n.useState(""),[b,L]=n.useState(!1);n.useEffect(()=>{w()},[w]),n.useEffect(()=>{if(y||v)return;const s=window.location.pathname+window.location.search;o(`/login?redirect=${encodeURIComponent(s)}`,{replace:!0})},[y,v,o]);const u=I.find(s=>s.id===r);n.useEffect(()=>{if(!N){if(!r){o("/",{replace:!0});return}u||(c.error("Plano não encontrado"),o("/",{replace:!0}))}},[N,r,u,o]);const m=!!(r&&u?.gatewayId&&!D),t=u,p=t?.price??0,U=p,A=n.useMemo(()=>t?.features?t.features.filter(s=>s.included).map(s=>s.text):[],[t?.features]),d=!!(i&&["active","trialing","past_due"].includes(i.status)),T=i?.status==="trialing"?"em teste":i?.status==="past_due"?"com pagamento pendente":i?.status==="active"?"ativa":"";n.useEffect(()=>{if(!g||d)return;let s=!1;const a=Date.now();return(async()=>{for(;!s;){if(await S(),Date.now()-a>6e4)return;await new Promise(l=>setTimeout(l,2e3))}})(),()=>{s=!0}},[g,S,d]);const G=async()=>{try{const a=`${window.location.origin}/dashboard/settings`,{data:x,error:l}=await k.functions.invoke("stripe-portal",{body:{returnUrl:a}});if(l)throw l;const h=x?.url;if(!h)throw new Error("URL do portal não retornada");window.location.href=h}catch(s){const a=s instanceof Error?s.message:String(s);c.error(`Erro ao abrir portal: ${a}`)}},_=async s=>{if(s.preventDefault(),!r){c.error("Plano não selecionado ou inválido");return}if(!m){c.error("Pagamento indisponível para este plano");return}if(d){c("Você já possui uma assinatura ativa.");return}try{L(!0);const a=window.location.origin,x=`${a}/checkout?success=1&plan=${encodeURIComponent(r)}`,l=`${a}/`,{data:h,error:E}=await k.functions.invoke("stripe-checkout",{body:{planId:r,successUrl:x,cancelUrl:l,cpf:P}});if(E)throw E;const R=h?.url;if(!R)throw new Error("URL de checkout não retornada");window.location.href=R}catch(a){console.error("Error creating Stripe checkout session:",a),c.error("Erro ao redirecionar para pagamento")}finally{L(!1)}};return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-6xl animate-fade-in-up",children:[e.jsx(J,{to:"/",className:"flex items-center justify-center gap-2 mb-8",children:e.jsx(Q,{className:"h-32 w-auto",alt:"Guildas"})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs(C,{className:"p-8 lg:order-last",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Resumo do Pedido"}),e.jsxs("div",{className:"p-6 rounded-xl bg-gradient-to-br from-neon-blue/10 to-neon-violet/10 border border-white/10 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold",children:t?.name??"Plano"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:t?.interval==="yearly"?"Plano Anual":"Plano Mensal"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold",children:["R$ ",p.toLocaleString("pt-BR",{minimumFractionDigits:2})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["/",t?.interval==="monthly"?"mês":"ano"]})]})]}),e.jsxs("div",{className:"border-t border-white/10 pt-4",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Incluído:"}),e.jsx("ul",{className:"space-y-1 text-sm text-muted-foreground",children:A.map((s,a)=>e.jsxs("li",{children:["✓ ",s]},a))})]})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{children:["R$ ",p.toLocaleString("pt-BR",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Desconto (14 dias grátis)"}),e.jsxs("span",{className:"text-neon-blue",children:["-R$ ",U.toLocaleString("pt-BR",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"border-t border-border pt-3 flex justify-between text-xl font-bold",children:[e.jsx("span",{children:"Total hoje"}),e.jsx("span",{children:"R$ 0,00"})]})]}),e.jsx("div",{className:"p-4 rounded-lg bg-neon-blue/10 border border-neon-blue/20",children:e.jsxs("p",{className:"text-sm text-center",children:[e.jsx($,{className:"w-4 h-4 inline mr-1"}),"Cobrança de R$ ",p.toLocaleString("pt-BR",{minimumFractionDigits:2})," após 14 dias"]})})]}),e.jsxs(C,{className:"p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Finalizar assinatura"}),(F||g)&&!d&&e.jsx("div",{className:"p-4 rounded-lg bg-neon-blue/10 border border-neon-blue/20 text-sm mb-6",children:"Estamos confirmando sua assinatura. Isso pode levar alguns segundos."}),d&&e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:`p-4 rounded-lg text-sm ${i?.status==="past_due"?"bg-yellow-500/10 border border-yellow-500/20":"bg-neon-blue/10 border border-neon-blue/20"}`,children:["Sua assinatura está ",T,"."]}),e.jsxs("div",{className:"flex gap-3 flex-col sm:flex-row",children:[e.jsx(j,{variant:"neon",className:"w-full",onClick:()=>o("/dashboard/settings"),children:"Ir para configurações"}),e.jsxs(j,{variant:"glass",className:"w-full",onClick:G,children:[e.jsx(W,{className:"w-4 h-4 mr-2"}),"Gerenciar no Stripe"]})]})]}),e.jsxs("form",{onSubmit:_,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"cpf",children:"CPF (opcional)"}),e.jsx(K,{id:"cpf",placeholder:"000.000.000-00",value:P,onChange:s=>B(s.target.value),className:"glass-card border-white/10"})]}),e.jsx("div",{className:"p-4 rounded-lg bg-white/5 border border-white/10 text-sm",children:"Você será redirecionado para o Stripe para inserir os dados do cartão com segurança."}),!m&&e.jsx("div",{className:"p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20 text-sm text-center",children:"Pagamento indisponível no momento para este plano."}),e.jsxs(j,{type:"submit",variant:"neon",disabled:!m||b||!t,className:`w-full text-lg py-6 ${!m||b||!t?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx($,{className:"w-5 h-5 mr-2"}),b?"Redirecionando...":"Continuar no Stripe"]}),e.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"Ao confirmar, você concorda com nossos Termos de Uso e Política de Privacidade. Cancelamento gratuito a qualquer momento."})]})]})]})]})})}export{ne as default};
