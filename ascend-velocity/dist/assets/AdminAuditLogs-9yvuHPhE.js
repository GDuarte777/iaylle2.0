import{j as t,I as N,H as y,o as e,a1 as C,N as L,ac as S}from"./index-DidJ2IC_.js";import{G as A}from"./GlassCard-i8sBZgct.js";import{I as E}from"./input-RWOkaWNK.js";import{T,a as k,b,c,d as B,e as i}from"./table-Bqyslwhj.js";import{S as I}from"./search-CTyYii5Y.js";function q(){const[_,h]=t.useState(!0),[n,v]=t.useState(""),[d,p]=t.useState([]),[m,x]=t.useState({}),u=t.useCallback(async()=>{h(!0);try{const{data:a,error:s}=await N.from("audit_logs").select("id, actor_id, entity_table, entity_id, action, created_at").order("created_at",{ascending:!1}).range(0,199);if(s)throw s;const o=a??[];p(o);const l=Array.from(new Set(o.map(r=>r.actor_id).filter(r=>!!r)));if(l.length===0){x({});return}const{data:f,error:g}=await N.from("profiles").select("id, email, full_name").in("id",l);if(g)throw g;const w={};(f??[]).forEach(r=>{w[r.id]=r}),x(w)}catch(a){const s=a instanceof Error?a.message:String(a);y.error(`Erro ao carregar logs: ${s}`),p([]),x({})}finally{h(!1)}},[]);t.useEffect(()=>{u()},[u]);const j=t.useMemo(()=>{const a=n.trim().toLowerCase();return a?d.filter(s=>{const o=s.actor_id?m[s.actor_id]:void 0,l=o?.email?.toLowerCase()??"",f=o?.full_name?.toLowerCase()??"";return s.entity_table.toLowerCase().includes(a)||(s.entity_id??"").toLowerCase().includes(a)||s.action.toLowerCase().includes(a)||l.includes(a)||f.includes(a)}):d},[m,d,n]);return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold mb-2 flex items-center gap-3",children:[e.jsx(C,{className:"w-8 h-8 text-purple-600 dark:text-purple-400"}),"Logs de Auditoria"]}),e.jsx("p",{className:"text-muted-foreground",children:"Acompanhe alterações feitas por admins e sistema."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative flex-1 sm:w-96",children:[e.jsx(I,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(E,{value:n,onChange:a=>v(a.target.value),placeholder:"Buscar por tabela, ação, actor, id...",className:"pl-10 bg-background/60"})]}),e.jsxs(L,{variant:"glass",onClick:()=>{u()},className:"gap-2",children:[e.jsx(S,{className:"w-4 h-4"}),"Atualizar"]})]})]}),e.jsx(A,{className:"p-6",children:_?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Carregando..."}):j.length===0?e.jsx("div",{className:"py-10 text-center text-muted-foreground",children:"Nenhum log encontrado."}):e.jsxs(T,{children:[e.jsx(k,{children:e.jsxs(b,{children:[e.jsx(c,{children:"Quando"}),e.jsx(c,{children:"Ator"}),e.jsx(c,{children:"Tabela"}),e.jsx(c,{children:"Ação"}),e.jsx(c,{children:"Entidade"})]})}),e.jsx(B,{children:j.map(a=>{const s=a.actor_id?m[a.actor_id]:void 0;return e.jsxs(b,{children:[e.jsx(i,{className:"whitespace-nowrap",children:new Date(a.created_at).toLocaleString("pt-BR")}),e.jsx(i,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s?.full_name??"Sistema"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s?.email??a.actor_id??""})]})}),e.jsx(i,{className:"font-medium",children:a.entity_table}),e.jsx(i,{className:"capitalize",children:a.action.toLowerCase()}),e.jsx(i,{className:"text-muted-foreground",children:a.entity_id??"—"})]},a.id)})})]})})]})}export{q as default};
